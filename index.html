<!DOCTYPE html>
<html>
<head>
  <title>2019 Food Picks</title>
  <style type="text/css">
  table {
  	float: left;
  	margin: 50px;
  }
  table, th, td {
  	border: 1px solid black;
  }
  th, td {
  	padding: 10px;
  }
  </style>
</head>
<body style="padding: 0px; margin: 0px; background-color: transparent;">
  <script src="functions.js" type="text/javascript"></script>
  <script src="js/wheel.js?v=2" type="text/javascript"></script>
  
  <audio id="wheelAudio" preload="auto">
    <source src="sounds/WheelDecideFX1_Soft_Short.ogg" type="audio/ogg">
    <source src="sounds/WheelDecideFX1_Soft_Short.mp3" type="audio/mpeg">
  </audio>
  <audio id="wheelAudio2">
    <source src="sounds/WheelDecideFX1_Soft_Short.ogg" type="audio/ogg">
    <source src="sounds/WheelDecideFX1_Soft_Short.mp3" type="audio/mpeg">
  </audio>
  <audio id="wheelAudio3">
    <source src="sounds/WheelDecideFX1_Soft_Short.ogg" type="audio/ogg">
    <source src="sounds/WheelDecideFX1_Soft_Short.mp3" type="audio/mpeg">
  </audio>
  <audio id="wheelAudioFinal" preload="auto">
    <source src="sounds/wd-sound-fx-end.ogg" type="audio/ogg">
    <source src="sounds/wd-sound-fx-end.mp3" type="audio/mpeg">
  </audio>

  <div style="position: relative;">
    <canvas id="wheelcanvas" style="position: absolute; left: 0; top: 0; z-index: 0;" width="300" height="300">
    </canvas>
    <!-- 
    <canvas id="wheelcanvastop"
			style="position: absolute; left: 0; top: 0; z-index: 1;" width="300"
			height="300" onclick="spin();" onmousedown="wheelMouseDown(event);"
			onmousemove="wheelMouseMove(event);"
			onmouseup="wheelMouseUp(event); spin();"
			onmouseout="wheelMouseUp(event);">
    </canvas>
    -->
    <canvas id="wheelcanvastop"
			style="position: absolute; left: 0; top: 0; z-index: 1;" width="300"
			height="300" onmousedown="wheelMouseDown(event);"
			onmousemove="wheelMouseMove(event);"
			onmouseup="wheelMouseUp(event);"
			onmouseout="wheelMouseUp(event);">
    </canvas>
  </div>
  
  <div id="historyDiv" style="display:none;">
  	<table id="alloted"><thead><tr><th colspan="2">Allocated Items</th></tr><tr><th>Time</th><th>Item</th></tr></thead><tbody></tbody></table>
  	<table id="remaining"><thead><tr><th colspan="2">Remaining Items</th><tr><th>Item</th><th>Count</th></tr></thead><tbody></tbody></table>
  	<img src="images/return-button.png" id="returnButton" style="right: 100px; top: 0px; position: absolute; width: 50px; height: 50px;" title="Return" onclick="hideHistory();"/>
  </div>
  
  <div id="reset" style="right: 0px; top: 0px; position: absolute; z-index: 1000;">
    <img src="images/reset-button.png" id="resetButton" style="width: 50px; height: 50px;" onclick="reset();"/>
  </div>
  <div id="spin" style="right: 50px; top: 100px; position: absolute; z-index: 1000;">
    <img src="images/spin-button.png" id="spinButton" style="width: 100px; height: 100px;" onclick="spin();"/>
  </div>
  <div id="wheelbuttons" style="right: 0px; bottom: 0px; position: absolute; z-index: 1000;">
    <img src="images/hist-icon.png" style="width: 50px; height: 50px;"  id="historyButton" onclick="showHistory();"/>
    <img src="images/wd-audio-on.png" id="mutebutton" style="width: 50px; height: 50px;" onclick="toggleMute(this);"/>
  </div>

  <script type="application/javascript">
		
    var colors = ["#FFFF00", "#00FF00","#3333FF","#FF00FF","#FF2222","#00FFFF" ];
    var restaurants_orig = [
	  "Idli","Veg Noodles","Vellai Paniyaram","Kandharappam","Vadai","Sambhar","Red Chutney","Cocunut Chutney","Kurma","Kavuni Arisi",
	  "Thenga Manga Pattani Sundal","Modhagam","Thirattupaal","Cut Fruits","Coffee","Tea"
    ];
    var restaurants = localStorage.options ? JSON.parse(localStorage.options) : restaurants_orig.slice(0);
    //var counts_orig = [10,6,6,6,8,9,4,4,1,1,4,4,1,4,1,1];
    //var counts = localStorage.counts ? JSON.parse(localStorage.counts) : counts_orig.slice(0);
    var weights_orig = [10,6,6,6,8,9,4,4,1,1,4,4,1,4,1,1];
    var weights = localStorage.weights ? JSON.parse(localStorage.weights) : weights_orig.slice(0);
    var hist = localStorage.history ? JSON.parse(localStorage.history) : [];
	
    function setWeightedVariables() {
      numOptionsWeighted = restaurants.length;
      if (weights.length > 0) {
        for (var i = 0; i < weights.length; i++) {
          numOptionsWeighted += weights[i] - 1;
        }
      }
      arc = Math.PI / (numOptionsWeighted / 2);
      wedgeAngle = Math.PI * 2 / numOptionsWeighted;
            
      var desChoice = -1;
      desChoiceWeighted = desChoice;
      for (var i = 0; i < weights.length && i < desChoice; i++) {
        desChoiceWeighted += weights[i] - 1;
      }
      halfDesChoiceWeight = 0.5;
      if (weights.length > desChoice) {
        halfDesChoiceWeight = weights[desChoice] * 0.5;
      }
    }        
                
    var numcolors = colors.length;
    var numoptions = restaurants.length;
        
    var numOptionsWeighted;
    var arc;
    var desChoiceWeighted;
    var halfDesChoiceWeight;
        
    setWeightedVariables();
  
    if (numOptionsWeighted % 2 == 1) {
      isOddNumberOfChoices = true;
      isFirstSpinCycle = true;
    }
	
    var isCustomWidth = true;  
    var canv = document.getElementById("wheelcanvas");
    var canvTop = document.getElementById("wheelcanvastop");
  

    var isMobile = false;
    if( /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
      isMobile = true;
    }
	if (isMobile) {
		canvasWidth = canv.width;
		//var mutebutton = document.getElementById('mutebutton');
		//toggleMute(mutebutton);
	}
	var minDimension = 500;
	var maxWidth = 500;
	var maxHeight = 500;
    var canvasWidth = minDimension;
    var wheelRadius;
    var outsideRadiu;
    var textRadius;
    var insideRadius;

    initLayout();
    
    function initLayout() {
    	try {
          //if (window.frameElement) {
		  //maxWidth = window.frameElement.offsetWidth;
		  //maxHeight = window.frameElement.offsetHeight;
          maxWidth = Math.max(document.documentElement.clientWidth, window.innerWidth || 0)
          maxHeight = Math.max(document.documentElement.clientHeight, window.innerHeight || 0)
		  //}
		  minDimension = Math.min(maxWidth, maxHeight);
	    } catch(err) {}
        
	    canvasWidth = minDimension;
        canv.width = canvasWidth;
        canv.height = canvasWidth;
        wheelSize = canvasWidth;
        canvTop.width = canvasWidth;
        canvTop.height = canvasWidth;
        if (maxWidth > maxHeight) { // landscape
          canv.style.top = "0px";
          canvTop.style.top = "0px";
          canv.style.left = "" + (maxWidth-canvasWidth)/2 + "px";
          canvTop.style.left = "" + (maxWidth-canvasWidth)/2 + "px";
        } else { //portrait
          canv.style.left = "0px";
          canvTop.style.left = "0px";
          canv.style.top = "" + (maxHeight-canvasWidth)/2 + "px";
          canvTop.style.top = "" + (maxHeight-canvasWidth)/2 + "px";
        }

        wheelRadius = wheelSize * 0.5;
        outsideRadius = wheelRadius;
        textRadius = wheelRadius * 0.9;
        insideRadius = wheelRadius *0.1;
    }
		
    var context = canvTop.getContext('2d');
    
    // initial click-to-spin image that is displayed upon page load
    /*
    var imageObj = new Image();
    imageObj.onload = function() {
      context.drawImage(imageObj, 0, 0, canvasWidth, canvasWidth);
    };
    imageObj.src = 'images/WD-Click-to-Spin.png';
    */
    
    function reset() {
      if (confirm("Reset roulette wheel options to the original list ?")) {
        restaurants = restaurants_orig.slice(0);
        //counts = counts_orig.slice(0);
        weights = weights_orig.slice(0);
        hist = [];
        saveState();
        location.reload();
      }
    }
    
    function saveState() {
      localStorage.options = JSON.stringify(restaurants);
      //localStorage.counts = JSON.stringify(counts);
      localStorage.weights = JSON.stringify(weights);
      localStorage.history = JSON.stringify(hist);
    }

    function wheelMouseDown(e) {
      clearTopCanvas();
	  drawArrow();
	  var wheeldiv = document.getElementById("wheelcanvastop");
      midX = wheeldiv.offsetLeft+wheelRadius+wheeldiv.offsetParent.offsetLeft;
	  midY = wheeldiv.offsetTop+wheelRadius+wheeldiv.offsetParent.offsetTop;
	  lastX=e.clientX;
	  lastY=e.clientY;
      isMouseDown = true;
    }
  
    function drawRouletteWheel() {
      var canvas = document.getElementById("wheelcanvas");
      if (canvas.getContext) {

        ctx = canvas.getContext("2d");
        ctx.setTransform(1, 0, 0, 1, 0, 0);
	    ctx.clearRect(0,0,canv.width,canv.height);
	    ctx.strokeStyle = "black";
        ctx.lineWidth = 0;
        ctx.translate( canvas.width/2 , canvas.height/2 );
        ctx.font = 'bold 12px sans-serif';
        var weightedIndex = 0;
        for(var i = 0; i < numoptions; i++) {
          var weightedArc = arc;
          var weight = 1;
          if (weights.length > i) {
            weight = weights[i];
            weightedArc = arc * weight;
          }
         
          var angle = startAngle + weightedIndex * arc;
          ctx.fillStyle = colors[i%numcolors];
          ctx.beginPath();
          var endAngle = angle + weightedArc;
          // Chrome 43.0.2357.81 m arc issue
          if (endAngle > 6.282 && endAngle < 6.284) {
            endAngle = 6.282;
          }
          ctx.arc(0,0, outsideRadius, angle, endAngle, false);
          ctx.arc(0,0, insideRadius, endAngle, angle, true);
          ctx.fill();
          ctx.save();
          ctx.fillStyle = "black";
		  
          var angHalfArc = angle + weightedArc * 0.5 - 0.04;
          ctx.translate(Math.cos(angHalfArc) * textRadius, Math.sin(angHalfArc) * textRadius);
          ctx.rotate(angHalfArc + Math.PI);
          var text = restaurants[i];
          ctx.font = 'bold '+choiceTextSize[i]+'px sans-serif';
		 
          textHWidth = ctx.measureText(text).width;
          if (textHWidth > textRadius - 30) {
            text = text.substring(0,27) + "...";	
          }
          
          ctx.fillText(text, 0, 0);
          ctx.restore();
          weightedIndex += weight;
        }
        drawArrow();
      }
    }
    
  function spin() {
    clearTopCanvas();
	drawArrow();
    var minTimeToSpin = 3;
    var timeRange = 4;
	 var minAngleToStartRotating = 20;
	 var angleRange = 30;
    spinTime = 0;
    spinTimeTotal = minTimeToSpin * 1000;
	//playSound();
    angleSinceBeep = 0;
	timeSinceBeep = 0;
	 slowDown = false;
	 var desChoice = -1;
	 if (desChoice == -1) {
	    spinAngleStart = Math.random() * angleRange + minAngleToStartRotating; 
		setWheelImageSource();
		rotateWheelImage();
	 } else {
	    spinAngleStart = 45;
		setWheelImageSource();
		rotateWheelPreset();
	}

  }
  
  
  
  
  function setChoiceFontSizes() {
  // get the font size of each choice
	 var canvas = document.getElementById("wheelcanvas");
    if (canvas.getContext) {
      ctx = canvas.getContext("2d");
		choiceTextSize = [];
		for(var i = 0; i < numoptions; i++) {
			var text = restaurants[i];
			ctx.font = 'bold 18px sans-serif'; 
			var textHWidth = ctx.measureText(text).width;
			if (textHWidth > textRadius - 30) {
				ctx.font = 'bold 15px sans-serif';
				textHWidth = ctx.measureText(text).width;
				if (textHWidth > textRadius - 30) {
					choiceTextSize.push("12");
				} else {
					choiceTextSize.push("15");
				}
			} else {
				choiceTextSize.push("18");
			}
		}
		
		// backup fonts
		font_backup = choiceTextSize.slice(0);		  		
		
	}
  }
  
function rotateWheelPreset() {
    spinTime += 30;
    if(spinTime >= spinTimeTotal) {
      stopRotateWheelImage();
      return;
	} else if (slowDown) {
		var spinAngle = spinAngleStart - easeOut(spinTime, 0, spinAngleStart, spinTimeTotal);
		startAngle += (spinAngle * Math.PI / 180);
		drawRouletteWheel(); 
		spinTimeout = setTimeout('rotateWheelPreset()', 30);
	} else {
		var spinAngle = 20;
		startAngle += (spinAngle * Math.PI / 180);
		if (spinTime >= spinTimeTotal - 3600)  {
			var desChoice = -1;
			var desAngle;
                        
                        if (weights.length > 0) {
                            desAngle = (numOptionsWeighted - desChoiceWeighted - halfDesChoiceWeight) / numOptionsWeighted * 2*Math.PI;
                        } else {
                            desAngle = (numoptions - desChoice - halfDesChoiceWeight) / numoptions * 2*Math.PI;
                        }
                        
			var modAngle = startAngle % 2*Math.PI;
			var minAngle, maxAngle;
			var isWithin = false;
                        minAngle = desAngle - 0.1;
                        maxAngle = desAngle + 0.1;
                        if (modAngle < maxAngle && modAngle > minAngle) {
                            isWithin = true;
                        }
			if (isWithin) {
                            startAngle = desAngle;
                            spinTime = spinTimeTotal - 3677;
                            slowDown = true;
			}
		}
		drawRouletteWheelImage(spinAngle);
		spinTimeout = setTimeout('rotateWheelPreset()', 30);
	}
  }
 

  // backup choices
  var font_backup = [];

  
  function stopRotateWheelImage() {
    clearTimeout(spinTimeout);
	
	var choice = getCurrentChoiceWithWeights();
	var text = choice.text;
	var index = choice.index;
	var itemNumber = weights_orig[index] - weights[index] + 1;
	hist.push({'time':(new Date()).toJSON(),'item':text+" "+itemNumber});
	 
	var canvasTop = document.getElementById("wheelcanvastop");
	if (canvasTop.getContext) {
		
		ctxTop = canvasTop.getContext("2d");
		 
		ctxTop.font = 'bold 30px sans-serif';
		var textHWidth = ctxTop.measureText(text).width*0.5;
		if (textHWidth > wheelRadius) {
		  ctxTop.font = 'bold 12px sans-serif';
		  textHWidth = ctxTop.measureText(text).width*0.5;
		}
		
                var imageObj = new Image();

                imageObj.onload = function() {
                       ctxTop.drawImage(imageObj, 0, 0, canvasWidth, canvasWidth);
                       ctxTop.fillStyle = "white";
                       ctxTop.fillText(text, canvasWidth/2 - textHWidth, canvasWidth/2 + 10);
                };
                imageObj.src = 'images/stop-message-gradient-500.png';
                if (!isMuted) {
                    var audioFinal = document.getElementById("wheelAudioFinal");
                    audioFinal.play();
                }
	}
	
	// check if this is the last count in that item
	if (weights[index] > 1) {
		// if not, just decrease count
		//counts[index] = counts[index] - 1;
		weights[index] = weights[index] - 1;
	} else {
        // if last element, remove that option and its count
	
					if (restaurants.length > 1) {
                        restaurants.splice(index, 1);
                        //counts.splice(index, 1);
                        choiceTextSize.splice(index,1);
                        if (index < weights.length) {
                            weights.splice(index,1);
                        }
                        numoptions = numoptions - 1;
                        arc = Math.PI / (numoptions / 2);
                    } else {
                        restaurants = restaurants_orig.slice(0);
                        //counts = counts_orig.slice(0);
                        choiceTextSize = font_backup.slice(0);
                        weights = weights_orig.slice(0);
                        numoptions = restaurants.length;
                        arc = Math.PI / (numoptions / 2);
                    }
	}
                    setWeightedVariables();
                    
                    wheelImage = new Image();
                    drawRouletteWheel();
                    setWheelImageSource();
	
	

	saveState();
  }
  

  addTouchEventListeners();
  positionSpinButton();
  draw();
  
  function positionSpinButton() {
	var spinButton = document.getElementById("spin");
    maxWidth = Math.max(document.documentElement.clientWidth, window.innerWidth || 0);
    maxHeight = Math.max(document.documentElement.clientHeight, window.innerHeight || 0);
	if (maxWidth > maxHeight) {
		spinButton.style.top = "" + (maxHeight/2 - 50) + "px";
		spinButton.style.right = "0px";
		spinButton.style.left = null;
		spinButton.style.bottom = null;
	} else {
		spinButton.style.bottom = "0px";
		spinButton.style.left = "" + (maxWidth/2 - 50) + "px";
		spinButton.style.top = null;
		spinButton.style.right = null;
	}
  }
  
  function resizeScreen() {
	  positionSpinButton();
	  initLayout();
	  draw();
  }
  
//  function listener(event){
//	if (event.data == "spin") {
//	  spin();
//	}
//  }

	try {
		if (window.addEventListener){
//			addEventListener("message", listener, false);
			addEventListener("resize", resizeScreen, false);
		} else {
//			attachEvent("onmessage", listener);
			attachEvent("resize", resizeScreen);
			
		}
	} catch(err) {
        
	}
	
    function showHistory() {
    	var historyDiv = document.getElementById("historyDiv");
    	historyDiv.style.display = "block";
    	canv.style.display = "none";
    	canvTop.style.display = "none";
    	document.getElementById("spin").style.display = "none";
    	document.getElementById("wheelbuttons").style.display = "none";
    	
    	var alloted = document.getElementById("alloted").getElementsByTagName('tbody')[0];
    	var remaining = document.getElementById("remaining").getElementsByTagName('tbody')[0];
    	alloted.innerHTML="";
    	remaining.innerHTML="";
    	for (i=0; i<hist.length; i++) {
    		var row = alloted.insertRow(i);
    		var cell1 = row.insertCell(0);
    		var cell2 = row.insertCell(1);
    		cell1.innerHTML = hist[i].time;
    		cell2.innerHTML = hist[i].item;
    	}
    	for (i=0; i<restaurants.length; i++) {
    		var row = remaining.insertRow(i);
    		var cell1 = row.insertCell(0);
    		var cell2 = row.insertCell(1);
    		cell1.innerHTML = restaurants[i];
    		cell2.innerHTML = weights[i];
    	}
    }

    function hideHistory() {
    	var historyDiv = document.getElementById("historyDiv");
    	historyDiv.style.display = "none";
    	canv.style.display = "block";
    	canvTop.style.display = "block";
    	document.getElementById("spin").style.display = "block";
    	document.getElementById("wheelbuttons").style.display = "block";
    }
	
	</script>
</body>
</html>